<!DOCTYPE html>
<html >
  <head>
    <title>Admin</title>

    <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <link rel="shortcut icon" href=" ">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <meta name="description" content="Login and Registration Form with HTML5 and CSS3" />
        <meta name="keywords" content="html5, css3, form, switch, animation, :target, pseudo-class" />
        <meta name="author" content="Codrops" />
        <link rel="shortcut icon" href="#">

        <link rel="stylesheet" type="text/css" href="./css/demo.css" />
        <link rel="stylesheet" type="text/css" href="./css/style.css" />
        <link rel="stylesheet" type="text/css" href="./css/animate-custom.css" />
    
  </head>
  
    <body>
        <nav class="navbar navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand">LUSD Token</a>
                <form class="d-flex">
                    
                    <input type="button" class="btn btn-outline-success" id="btn-connect" value="Connect Metamask"></input>
                </form>
            </div>
        </nav>

        <div class="myDiv container">
            <h4><b>Check Balance : </b></h4>
            <label id="bal"></label> Balance : <br>
            <input type="button" class="btn btn-primary btn-lg" id="btn-balance" value="Balance"></input>	
        </div><br><br>

        <div class="myDiv container">
            <h4><b>Withdraw : </b></h4>
            <input type="text" id="account" class="form-control" width="400" placeholder="User Account"><br>
            <input type="button" class="btn btn-primary btn-lg" id="btn-withdraw" value="Withdraw"></input>

        </div><br><br>
       
        <script>
            $(document).ready(function(e){

            web3 = new Web3(window.web3.currentProvider);

            let oContractObject;
            var contract;
            let account;
            let adminContract;
            const BINANCE_CHAINID = `0x${Number(1337).toString(16)}`;


            
            async function metamaskCheck() {

            try {
                if (window.ethereum != 'undefined') {
                    oWeb3 = new Web3(window.ethereum);
                    console.log("Metamask is installed");
                    const reqAccount = await ethereum.request({ method: "eth_requestAccounts" })
                    console.log(`Connected to ${reqAccount} account`);
                    return reqAccount;
                }
            } catch (error) {
                console.log(error); 
            }

            }

        $("#btn-connect").on('click', async() => {

            try {
                metamaskCheck();

                let reqChainId = await window.ethereum.request({
                    method: "eth_chainId"
                })

                console.log(`Metamask is connected to ${reqChainId} chain ID`);

                try {
                    await window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: BINANCE_CHAINID }]
                    })
                    reqAccount = await window.ethereum.request({
                        method: "eth_requestAccounts"
                    })
                    account = reqAccount[0];
                    console.log("Account address: ", account.toString());

                    finalChainId = await window.ethereum.request({
                    method: "eth_chainId"
                    })

                    console.log(`Connected metamask account: ${finalChainId}`);

            } catch (error) {
                console.log(error);
            }

            contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
            adminContract = new web3.eth.Contract(ADMIN_ABI, ADMIN_CONTRACT_ADDRESS);

            console.log("Contract Object: ", contract);
            console.log("admin-contract",adminContract);


        } catch (error) {
            console.log(error);
        }

        })

        $("#btn-balance").on("click",async function(e) {

            if(!account){
		        alert("Connect to metamask First!");
                return;
	        }

            adminContract.methods.balanceOf().call().then(function(result){
                console.log("result : ",result);
                result = (result)/10**4;
                $("#bal").text(result);
            }).catch(function(error){
                console.log(error);
            })
        })

        $("#btn-withdraw").on("click",async function(e){
            console.log("Withdraw clicked!");

            if(!account){
		        alert("connect to metamask!");
                return;
	        }

            let userAccount  = $("#account").val()
            console.log("accounts", userAccount);

            if(!web3.utils.isAddress(userAccount)){
                alert("address is invalid or empty");
                return;     
            }

            let data = {
                userAccount: userAccount
            }

            $.ajax({
                    type: 'POST',
                    url: '/api/v1/admin/adminData',
                    data: data,
                    success:function(result,status,xhr){
                        console.log("result =>>>> : ",result)
                            result = result*10**4;
                            if(result <= 0){
                                alert("already withdrawed");
                                return;
                            }
                            adminContract.methods.withdraw(userAccount,result).send({from : account })
                            .on("transactionHash", (txHash) => {
		                        console.log("Transaction Hash: ", txHash);
	                        })
	                        .on("receipt", (receipt)=> {
		                        console.log("Receipt", receipt);
		                        alert("withdraw Successfully");
                                 $.ajax({
                                    type: 'delete',
                                    url: '/api/v1/admin/deleteData',
                                    data: data,
                                    success:function(result,status,xhr){
                                        console.log("result =>>>> : ",result)
                                        return;
                                        
                                    },
                                    error:function(error){
                                        alert("Transaction is Failed");
                                        return;
                                    }
                                })
                                
        	                })
	                        .catch((err) => {
		                        console.error(err);
		                        alert("Error: Failed to withdraw")
        	                })
                    },
                    error:function(error){
                        alert("Transaction is Failed");
                        return;
                    }

        })

    })
})

    </script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
         integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
         crossorigin="anonymous"></script>
         <script src="../assets/js/jquery.js"></script>
         <script src="../assets/js/web3.min.js"></script>
         <script src="../assets/js/abi.js"></script>
         <script src="../assets/js/contractAddress.js"></script>

    </body>

    </html>
